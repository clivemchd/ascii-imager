<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to ASCII Converter</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé®</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé®</text></svg>">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .upload-section {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .file-input {
            margin: 10px;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: border-color 0.3s;
            position: relative;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .file-input:hover {
            border-color: #007bff;
        }
        
        .file-input.has-image {
            border-color: #28a745;
            border-style: solid;
        }
        
        .upload-content {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            max-width: 300px;
        }
        
        .file-input.has-image .upload-content {
            background: rgba(0, 0, 0, 0.7);
            color: white;
        }
        
        .image-info {
            margin-top: 10px;
            font-size: 12px;
        }
        
        .image-info p {
            margin: 2px 0;
        }
        
        #imageInput {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        
        .control-group {
            margin: 10px;
            display: inline-block;
            flex: 1;
            min-width: 200px;
        }
        
        .control-group-vertical {
            margin: 15px 0;
            display: block;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 200px;
            margin: 0 10px;
        }
        
        input[type="text"] {
            width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        .preview-section {
            margin: 30px 0;
            text-align: center;
        }
        
        .original-image {
            max-width: 300px;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .ascii-output {
            background-color: #000;
            color: #00ff00;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 8px;
            line-height: 8px;
            white-space: pre;
            overflow-x: auto;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .custom-input-group {
            margin-top: 10px;
            text-align: center;
        }
        
        .custom-input-group small {
            display: block;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® Image to ASCII Art Converter</h1>
        
        <div class="upload-section">
            <div class="file-input" id="fileInputArea">
                <input type="file" id="imageInput" accept="image/*" />
                <div class="upload-content">
                    <p id="uploadText">Choose an image file or drag and drop</p>
                    <div id="imageInfo" class="image-info hidden">
                        <p id="imageName"></p>
                        <p id="imageDimensions"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="totalChars">Total Characters (optional):</label>
                    <input type="number" id="totalChars" placeholder="Leave empty for auto calculation" min="100" max="50000" style="width: 180px;" />
                    <small style="display: block; color: #666; font-size: 11px; margin-top: 2px;">
                        If specified, calculates optimal dimensions
                    </small>
                </div>
                
                <div class="control-group">
                    <label for="charsetSelect">Character Set:</label>
                    <select id="charsetSelect">
                        <option value="detailed">Detailed: @%#*+=-:. </option>
                        <option value="simple">Simple: ‚ñà‚ñâ‚ñä‚ñã‚ñå‚ñç‚ñé‚ñè </option>
                        <option value="blocks">Blocks: ‚ñà‚ñà‚ñì‚ñí‚ñë  </option>
                        <option value="custom">Custom (enter your own)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="downloadFormat">Download Format:</label>
                    <select id="downloadFormat">
                        <option value="png">PNG Image</option>
                        <option value="svg">SVG Vector</option>
                        <option value="txt">Text File</option>
                    </select>
                </div>
            </div>
            
            <div id="customInputGroup" class="custom-input-group hidden">
                <label for="customCharset">Custom Characters:</label>
                <input type="text" id="customCharset" placeholder="Enter characters from dark to light (e.g., @#*+=-:. )" value="@#*+=-:. " />
                <small>Characters should be ordered from darkest to lightest</small>
            </div>
            
            <div class="control-group-vertical">
                <label>
                    <input type="checkbox" id="invertColors" />
                    Invert Colors (dark areas become light)
                </label>
            </div>
            
            <div class="control-group-vertical">
                <label for="textColor">Text Color:</label>
                <input type="color" id="textColor" value="#00ff00" />
            </div>
            
            <div class="control-group-vertical">
                <label for="backgroundColor">Background Color:</label>
                <input type="color" id="backgroundColor" value="#000000" />
            </div>
            
            <br>
            <button id="convertBtn">Convert to ASCII</button>
            <button id="downloadBtn" class="hidden">Download ASCII</button>
        </div>
        
        <div class="preview-section">
            <div id="loading" class="loading hidden">Converting image...</div>
            <div id="asciiOutput" class="ascii-output hidden"></div>
        </div>
    </div>
    
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        class ImageToAscii {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.imageInput = document.getElementById('imageInput');
                this.originalImage = document.getElementById('originalImage');
                this.asciiOutput = document.getElementById('asciiOutput');
                this.convertBtn = document.getElementById('convertBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.loading = document.getElementById('loading');
                
                this.totalChars = document.getElementById('totalChars');
                this.charsetSelect = document.getElementById('charsetSelect');
                this.customCharset = document.getElementById('customCharset');
                this.customInputGroup = document.getElementById('customInputGroup');
                this.downloadFormat = document.getElementById('downloadFormat');
                this.invertColors = document.getElementById('invertColors');
                this.textColor = document.getElementById('textColor');
                this.backgroundColor = document.getElementById('backgroundColor');
                
                this.currentImage = null;
                this.asciiResult = '';
                
                this.initializeEventListeners();
            }
            
            initializeEventListeners() {
                this.imageInput.addEventListener('change', (e) => this.handleImageUpload(e));
                this.convertBtn.addEventListener('click', () => this.convertToAscii());
                this.downloadBtn.addEventListener('click', () => this.downloadAscii());
                
                // Handle character set selection
                this.charsetSelect.addEventListener('change', () => {
                    this.toggleCustomInput();
                });
                
                // Handle color changes
                this.textColor.addEventListener('change', () => {
                    this.updateOutputColors();
                });
                
                this.backgroundColor.addEventListener('change', () => {
                    this.updateOutputColors();
                });
                
                // Drag and drop functionality
                const fileInput = document.querySelector('.file-input');
                fileInput.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileInput.style.borderColor = '#007bff';
                });
                
                fileInput.addEventListener('dragleave', () => {
                    fileInput.style.borderColor = '#ddd';
                });
                
                fileInput.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileInput.style.borderColor = '#ddd';
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleImageFile(files[0]);
                    }
                });
            }
            
            toggleCustomInput() {
                if (this.charsetSelect.value === 'custom') {
                    this.customInputGroup.classList.remove('hidden');
                } else {
                    this.customInputGroup.classList.add('hidden');
                }
            }
            
            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    this.handleImageFile(file);
                }
            }
            
            handleImageFile(file) {
                if (!file.type.startsWith('image/')) {
                    alert('Please select a valid image file.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.currentImage = new Image();
                    this.currentImage.onload = () => {
                        // Update the drag area to show the image
                        const fileInputArea = document.getElementById('fileInputArea');
                        fileInputArea.style.backgroundImage = `url(${e.target.result})`;
                        fileInputArea.classList.add('has-image');
                        
                        // Update the upload text and show image info
                        const uploadText = document.getElementById('uploadText');
                        const imageInfo = document.getElementById('imageInfo');
                        const imageName = document.getElementById('imageName');
                        const imageDimensions = document.getElementById('imageDimensions');
                        
                        uploadText.textContent = 'Image loaded - Click to change';
                        imageName.textContent = `üìÅ ${file.name}`;
                        imageDimensions.textContent = `üìê ${this.currentImage.width} √ó ${this.currentImage.height}px`;
                        
                        imageInfo.classList.remove('hidden');
                        
                        this.convertBtn.disabled = false;
                    };
                    this.currentImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            getCharacterSet() {
                const charsets = {
                    detailed: '@%#*+=-:. ',
                    simple: '‚ñà‚ñâ‚ñä‚ñã‚ñå‚ñç‚ñé‚ñè ',
                    blocks: '‚ñà‚ñà‚ñì‚ñí‚ñë  '
                };
                
                if (this.charsetSelect.value === 'custom') {
                    const customChars = this.customCharset.value.trim();
                    if (customChars.length === 0) {
                        alert('Please enter custom characters!');
                        return charsets.detailed;
                    }
                    return customChars;
                }
                
                return charsets[this.charsetSelect.value] || charsets.detailed;
            }
            
            updateOutputColors() {
                if (this.asciiOutput) {
                    this.asciiOutput.style.backgroundColor = this.backgroundColor.value;
                    this.asciiOutput.style.color = this.textColor.value;
                }
            }
            
            convertToAscii() {
                if (!this.currentImage) return;
                
                // Validate custom character set if selected
                if (this.charsetSelect.value === 'custom') {
                    const customChars = this.customCharset.value.trim();
                    if (customChars.length === 0) {
                        alert('Please enter custom characters before converting!');
                        return;
                    }
                }
                
                this.loading.classList.remove('hidden');
                this.asciiOutput.classList.add('hidden');
                
                // Use setTimeout to allow loading message to display
                setTimeout(() => {
                    // Use default values
                    const contrast = 1.0; // Default contrast
                    const defaultWidth = 100; // Default width
                    const charset = this.getCharacterSet();
                    const shouldInvert = this.invertColors.checked;
                    
                    let width, height;
                    
                    // Check if user specified total characters
                    const totalCharsInput = this.totalChars.value.trim();
                    if (totalCharsInput && !isNaN(totalCharsInput) && parseInt(totalCharsInput) > 0) {
                        // User specified total characters - calculate dimensions for that character count
                        const totalChars = parseInt(totalCharsInput);
                        const aspectRatio = this.currentImage.height / this.currentImage.width;
                        
                        // Calculate width and height to achieve target total characters
                        width = Math.round(Math.sqrt(totalChars / (aspectRatio * 0.5)));
                        height = Math.round(totalChars / width);
                        
                        // Ensure minimum dimensions
                        width = Math.max(width, 10);
                        height = Math.max(height, 5);
                        
                        console.log(`Using total characters: ${totalChars}, calculated dimensions: ${width}√ó${height} = ${width * height} chars`);
                    } else {
                        // Use default width
                        width = defaultWidth;
                        const aspectRatio = this.currentImage.height / this.currentImage.width;
                        height = Math.floor(width * aspectRatio * 0.5);
                        
                        console.log(`Using default width: ${width}, calculated height: ${height}, total: ${width * height} chars`);
                    }
                    
                    // Set canvas size
                    this.canvas.width = width;
                    this.canvas.height = height;
                    
                    // Draw image on canvas
                    this.ctx.drawImage(this.currentImage, 0, 0, width, height);
                    
                    // Get image data
                    const imageData = this.ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;
                    
                    let ascii = '';
                    for (let i = 0; i < height; i++) {
                        for (let j = 0; j < width; j++) {
                            const pixelIndex = (i * width + j) * 4;
                            const r = data[pixelIndex];
                            const g = data[pixelIndex + 1];
                            const b = data[pixelIndex + 2];
                            
                            // Calculate brightness
                            const brightness = (r + g + b) / 3;
                            
                            // Apply contrast (using default value)
                            const adjustedBrightness = Math.max(0, Math.min(255, brightness * contrast));
                            
                            // Map brightness to character
                            const charIndex = Math.floor((adjustedBrightness / 255) * (charset.length - 1));
                            
                            // Apply inversion if checked
                            const finalCharIndex = shouldInvert ? (charset.length - 1 - charIndex) : charIndex;
                            ascii += charset[finalCharIndex];
                        }
                        ascii += '\n';
                    }
                    
                    this.asciiResult = ascii;
                    this.asciiOutput.textContent = ascii;
                    
                    // Adjust font size to maintain consistent visual output size
                    this.adjustFontSizeForCharacterCount(width, height);
                    
                    this.asciiOutput.classList.remove('hidden');
                    this.downloadBtn.classList.remove('hidden');
                    this.loading.classList.add('hidden');
                    
                    // Apply custom colors
                    this.updateOutputColors();
                }, 100);
            }
            
            adjustFontSizeForCharacterCount(width, height) {
                // Calculate font size to maintain consistent visual output size
                // Base calculation on a target display area
                const targetDisplayWidth = 800; // pixels
                const targetDisplayHeight = 600; // pixels
                
                // Calculate what font size would fit this character grid in the target area
                const fontSizeByWidth = Math.max(1, Math.floor(targetDisplayWidth / width));
                const fontSizeByHeight = Math.max(1, Math.floor(targetDisplayHeight / height));
                
                // Use the smaller of the two to ensure it fits
                const fontSize = Math.min(fontSizeByWidth, fontSizeByHeight);
                const lineHeight = fontSize;
                
                // Apply the calculated font size
                this.asciiOutput.style.fontSize = `${fontSize}px`;
                this.asciiOutput.style.lineHeight = `${lineHeight}px`;
                
                console.log(`Adjusted font size to ${fontSize}px for ${width}√ó${height} character grid`);
            }
            
            downloadAscii() {
                if (!this.asciiResult) return;
                
                const format = this.downloadFormat.value;
                
                switch (format) {
                    case 'png':
                        this.downloadAsPNG();
                        break;
                    case 'svg':
                        this.downloadAsSVG();
                        break;
                    case 'txt':
                        this.downloadAsText();
                        break;
                    default:
                        this.downloadAsPNG();
                }
            }
            
            downloadAsPNG() {
                // Create a temporary canvas for rendering ASCII as image
                const downloadCanvas = document.createElement('canvas');
                const downloadCtx = downloadCanvas.getContext('2d');
                
                // High-quality settings
                const fontSize = 16; // Increased from 8
                const lineHeight = 16; // Increased from 8
                const scaleFactor = 2; // For high DPI/retina displays
                
                // Set up font and measure text
                downloadCtx.font = `${fontSize}px 'Courier New', monospace`;
                
                // Split ASCII into lines and calculate canvas dimensions
                const lines = this.asciiResult.split('\n').filter(line => line.length > 0);
                const maxLineLength = Math.max(...lines.map(line => line.length));
                
                // Calculate canvas size with higher resolution
                const charWidth = downloadCtx.measureText('M').width;
                const baseWidth = Math.ceil(maxLineLength * charWidth) + 40; // Increased padding
                const baseHeight = Math.ceil(lines.length * lineHeight) + 40; // Increased padding
                
                // Scale for high quality
                const canvasWidth = baseWidth * scaleFactor;
                const canvasHeight = baseHeight * scaleFactor;
                
                // Set canvas dimensions
                downloadCanvas.width = canvasWidth;
                downloadCanvas.height = canvasHeight;
                
                // Scale context for high DPI
                downloadCtx.scale(scaleFactor, scaleFactor);
                
                // Enable font smoothing and high-quality rendering
                downloadCtx.imageSmoothingEnabled = true;
                downloadCtx.imageSmoothingQuality = 'high';
                downloadCtx.textRenderingOptimization = 'optimizeQuality';
                
                // Fill background with selected color
                downloadCtx.fillStyle = this.backgroundColor.value;
                downloadCtx.fillRect(0, 0, baseWidth, baseHeight);
                
                // Set text properties with selected color and high quality
                downloadCtx.font = `${fontSize}px 'Courier New', monospace`;
                downloadCtx.fillStyle = this.textColor.value;
                downloadCtx.textBaseline = 'top';
                downloadCtx.textAlign = 'left';
                
                // Draw each line of ASCII art with better positioning
                lines.forEach((line, index) => {
                    const x = 20; // Increased padding
                    const y = 20 + (index * lineHeight); // Increased padding
                    downloadCtx.fillText(line, x, y);
                });
                
                // Convert canvas to blob with high quality settings
                downloadCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ascii-art-hq.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 'image/png', 1.0); // Maximum quality
            }
            
            downloadAsSVG() {
                const lines = this.asciiResult.split('\n').filter(line => line.length > 0);
                const maxLineLength = Math.max(...lines.map(line => line.length));
                
                // Higher quality settings for SVG
                const fontSize = 16; // Increased from 8
                const lineHeight = 18; // Slightly increased spacing
                const charWidth = 9.6; // Adjusted for larger font
                
                const width = Math.ceil(maxLineLength * charWidth) + 40; // Increased padding
                const height = Math.ceil(lines.length * lineHeight) + 40; // Increased padding
                
                let svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
    <rect width="100%" height="100%" fill="${this.backgroundColor.value}"/>
    <style>
        .ascii-text {
            font-family: 'Courier New', monospace;
            font-size: ${fontSize}px;
            fill: ${this.textColor.value};
            white-space: pre;
            font-weight: normal;
            text-rendering: optimizeLegibility;
            shape-rendering: crispEdges;
        }
    </style>`;
                
                lines.forEach((line, index) => {
                    const y = 20 + (index * lineHeight) + fontSize - 2; // Adjusted positioning
                    svgContent += `\n    <text x="20" y="${y}" class="ascii-text">${line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</text>`;
                });
                
                svgContent += '\n</svg>';
                
                const blob = new Blob([svgContent], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ascii-art-hq.svg';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            downloadAsText() {
                const blob = new Blob([this.asciiResult], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ascii-art.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new ImageToAscii();
        });
    </script>
</body>
</html>